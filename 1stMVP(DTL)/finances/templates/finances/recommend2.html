{% extends "base.html" %}
{% block title %}íšŒì› ì •ë³´ ë° ê³ ë°°ë‹¹ ë­í‚¹{% endblock %}
{% block nav_fin %}active{% endblock %}
{% block content %}
<section class="grid-profile">
  <!-- ìê¸°ì†Œê°œ -->
  <div class="intro-area">
    <div class="field">
      <div class="label">ìê¸° ì†Œê°œ</div>
      <div class="inline">
        <textarea id="intro" class="textarea" placeholder="ê°„ë‹¨í•œ ì†Œê°œë¥¼ ì…ë ¥í•˜ì„¸ìš”."></textarea>
        <button class="btn primary" id="btn-save-intro">Update</button>
      </div>
      <div id="intro-status" class="hint">ì €ì¥ë˜ì§€ ì•ŠìŒ</div>

      <div class="image-upload">
        <label for="image-input" class="btn ghost">ì´ë¯¸ì§€ ì—…ë¡œë“œ</label>
        <input type="file" id="image-input" accept="image/*" class="hidden" />
        <div id="image-preview" class="preview"></div>
      </div>
    </div>
  </div>

  <!-- íˆ¬ì ì„±í–¥ -->
  <div class="prefs-area">
    <div class="section-title">íˆ¬ì ì„±í–¥</div>
    <div class="panel">
      <div class="field">
        <div class="label">íˆ¬ììƒí’ˆ ì„ í˜¸ë„(ë³µìˆ˜ ì„ íƒ)</div>
        <div class="chips checks" id="product-prefs">
          <label class="chip"><input type="checkbox" value="ë°°ë‹¹ì£¼" /> ë°°ë‹¹ì£¼</label>
          <label class="chip"><input type="checkbox" value="ì„±ì¥ì£¼" /> ì„±ì¥ì£¼</label>
          <label class="chip"><input type="checkbox" value="ê°€ì¹˜ì£¼" /> ê°€ì¹˜ì£¼</label>
          <label class="chip"><input type="checkbox" value="ë¦¬ì¸ " /> ë¦¬ì¸ </label>
          <label class="chip"><input type="checkbox" value="ETF" /> ETF</label>
          <label class="chip"><input type="checkbox" value="ì±„ê¶Œ" /> ì±„ê¶Œ</label>
        </div>
      </div>

      <div class="field">
        <div class="label">íˆ¬ì ìŠ¤íƒ€ì¼(ë‹¨ì¼ ì„ íƒ)</div>
        <div class="chips radios" id="style-prefs">
          <label class="chip"><input type="radio" name="style" value="ì•ˆì •í˜•" /> ì•ˆì •í˜•</label>
          <label class="chip"><input type="radio" name="style" value="ê· í˜•í˜•" /> ê· í˜•í˜•</label>
          <label class="chip"><input type="radio" name="style" value="ê³µê²©í˜•" /> ê³µê²©í˜•</label>
        </div>
      </div>

      <div class="field">
        <div class="label">ê´€ì‹¬ ì¢…ëª©/ì¢…ë¥˜(ë³µìˆ˜ ì„ íƒ)</div>
        <div class="chips checks" id="sector-prefs">
          <label class="chip"><input type="checkbox" value="ì€í–‰" /> ì€í–‰</label>
          <label class="chip"><input type="checkbox" value="í†µì‹ " /> í†µì‹ </label>
          <label class="chip"><input type="checkbox" value="ë°˜ë„ì²´" /> ë°˜ë„ì²´</label>
          <label class="chip"><input type="checkbox" value="ìë™ì°¨" /> ìë™ì°¨</label>
          <label class="chip"><input type="checkbox" value="ì—ë„ˆì§€" /> ì—ë„ˆì§€</label>
          <label class="chip"><input type="checkbox" value="ë¦¬ì¸ /ë¶€ë™ì‚°" /> ë¦¬ì¸ /ë¶€ë™ì‚°</label>
        </div>
      </div>

      <div class="row">
        <button class="btn primary" id="btn-save-prefs">íˆ¬ì ì„±í–¥ ì €ì¥</button>
        <div id="prefs-status" class="status">ì €ì¥ë˜ì§€ ì•ŠìŒ</div>
      </div>
    </div>
  </div>
</section>

<!-- ê¸°ë³¸ ê°€ì¤‘ì¹˜ -->
<section class="panel">
  <h2>ğŸ“Š ê¸°ë³¸ ê°€ì¤‘ì¹˜ (ê· í˜•í˜•)</h2>
  <ul class="weights-list">
    <li>ROE: <strong>40%</strong></li>
    <li>ë°°ë‹¹: <strong>30%</strong></li>
    <li>PER: <strong>15%</strong></li>
    <li>PBR: <strong>15%</strong></li>
  </ul>
</section>

<!-- CSV ì—…ë¡œë“œ í…Œì´ë¸” -->
<section class="panel">
  <h2>KOSPI ê³ ë°°ë‹¹ ë­í‚¹</h2>
  <div class="row">
    <label for="csv-file" class="btn ghost">CSV ì—…ë¡œë“œ</label>
    <input id="csv-file" type="file" accept=".csv" class="hidden" />
    <button id="btn-download" class="btn small">í˜„ì¬ í‘œ CSVë¡œ ì €ì¥</button>
    <span id="rank-status" class="status">CSV ì—…ë¡œë“œ ì‹œ í‘œê°€ ë Œë”ë§ë©ë‹ˆë‹¤</span>
  </div>

  <div class="table-wrap">
    <table id="rank-table">
      <thead>
        <tr>
          <th>ì¢…ëª©ëª…</th>
          <th>ì ìˆ˜</th>
          <th>ë°°ë‹¹%</th>
          <th>ROE%</th>
          <th>PER%</th>
          <th>PBR%</th>
          <th>ì„¹í„°</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
  // CSV ì—…ë¡œë“œ í•¸ë“¤ëŸ¬
  document.getElementById('csv-file').addEventListener('change', function (e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function (event) {
      const text = event.target.result;
      const rows = text.trim().split('\n').map(row => row.split(','));

      const header = rows[0].map(h => h.trim());
      const lowerHeader = header.map(h => h.toLowerCase());

      const nameIdx = lowerHeader.indexOf('name');
      const scoreIdx = lowerHeader.indexOf('score');
      const divIdx = lowerHeader.indexOf('div');
      const roeIdx = lowerHeader.indexOf('roe_est');
      const perIdx = lowerHeader.indexOf('per');
      const pbrIdx = lowerHeader.indexOf('pbr');
      const sectorIdx = lowerHeader.indexOf('sector');

      const tbody = document.querySelector('#rank-table tbody');
      tbody.innerHTML = '';

      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const tr = document.createElement('tr');

        const format = (val) => {
          const num = parseFloat(val);
          return isNaN(num) || val === '' ? '-' : num.toFixed(2);
        };

        const cells = [
          row[nameIdx],
          format(row[scoreIdx]),
          format(row[divIdx]),
          format(row[roeIdx]),
          format(row[perIdx]),
          format(row[pbrIdx]),
          row[sectorIdx]
        ];

        cells.forEach(cell => {
          const td = document.createElement('td');
          td.textContent = (cell ?? '').toString().trim() || '-';
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      }

      const status = document.getElementById('rank-status');
      status.textContent = 'ì—…ë¡œë“œ ì™„ë£Œ';
      status.classList.add('ok');
    };

    reader.readAsText(file, 'UTF-8');
  });

  // (ì„ íƒ) ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
  const imageInput = document.getElementById('image-input');
  const imagePreview = document.getElementById('image-preview');
  if (imageInput && imagePreview) {
    imageInput.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const url = URL.createObjectURL(file);
      imagePreview.innerHTML = `<img src="${url}" alt="ë¯¸ë¦¬ë³´ê¸°" />`;
    });
  }

  // (ì„ íƒ) ìê¸°ì†Œê°œ/ì„±í–¥ ì €ì¥ ë²„íŠ¼ ìƒíƒœ í‘œì‹œ
  const introBtn = document.getElementById('btn-save-intro');
  const introStatus = document.getElementById('intro-status');
  introBtn?.addEventListener('click', () => {
    introStatus.textContent = 'ì €ì¥ë¨';
    introStatus.classList.add('ok');
  });

  const prefsBtn = document.getElementById('btn-save-prefs');
  const prefsStatus = document.getElementById('prefs-status');
  prefsBtn?.addEventListener('click', () => {
    prefsStatus.textContent = 'ì €ì¥ë¨';
    prefsStatus.classList.add('ok');
  });

  // (ì„ íƒ) í˜„ì¬ í…Œì´ë¸”ì„ CSVë¡œ ë‹¤ìš´ë¡œë“œ
  document.getElementById('btn-download')?.addEventListener('click', () => {
    const rows = [];
    const table = document.getElementById('rank-table');
    const trs = table.querySelectorAll('tr');
    trs.forEach(tr => {
      const cols = [...tr.children].map(td => {
        const text = td.textContent ?? '';
        // ì‰¼í‘œ/ë”°ì˜´í‘œ í¬í•¨ ì‹œ CSV ì•ˆì „ ì²˜ë¦¬ë¥¼ ìœ„í•œ ê°ì‹¸ê¸°
        if (text.includes(',') || text.includes('"')) {
          return `"${text.replace(/"/g, '""')}"`;
        }
        return text;
      });
      rows.push(cols.join(','));
    });
    const csv = rows.join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'ranking.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  });
</script>
{% endblock %}
