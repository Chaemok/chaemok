{% extends "base.html" %}
{% block title %}íšŒì› ì •ë³´ ë° ê³ ë°°ë‹¹ ë­í‚¹{% endblock %}
{% block nav_fin %}active{% endblock %}
{% block content %}

<section class="grid-profile">
  <!-- ìê¸°ì†Œê°œ -->
  <div class="intro-area">
    <div class="field">
      <div class="label">ìê¸° ì†Œê°œ</div>
      <div class="inline">
        <textarea id="intro" class="textarea" placeholder="ê°„ë‹¨í•œ ì†Œê°œë¥¼ ì…ë ¥í•˜ì„¸ìš”."></textarea>
        <button class="btn primary" id="btn-save-intro">Update</button>
      </div>
      <div id="intro-status" class="hint">ì €ì¥ë˜ì§€ ì•ŠìŒ</div>
      <div class="image-upload">
        <label for="image-input" class="btn ghost">ì´ë¯¸ì§€ ì—…ë¡œë“œ</label>
        <input type="file" id="image-input" accept="image/*" class="hidden" />
        <div id="image-preview" class="preview"></div>
      </div>
    </div>
  </div>

  <!-- íˆ¬ì ì„±í–¥ -->
  <div class="prefs-area">
    <div class="section-title">íˆ¬ì ì„±í–¥</div>
    <div class="panel">
      <div class="field">
        <div class="label">íˆ¬ììƒí’ˆ ì„ í˜¸ë„(ë³µìˆ˜ ì„ íƒ)</div>
        <div class="chips checks" id="product-prefs">
          <label class="chip"><input type="checkbox" value="ë°°ë‹¹ì£¼" /> ë°°ë‹¹ì£¼</label>
          <label class="chip"><input type="checkbox" value="ì„±ì¥ì£¼" /> ì„±ì¥ì£¼</label>
          <label class="chip"><input type="checkbox" value="ê°€ì¹˜ì£¼" /> ê°€ì¹˜ì£¼</label>
          <label class="chip"><input type="checkbox" value="ë¦¬ì¸ " /> ë¦¬ì¸ </label>
          <label class="chip"><input type="checkbox" value="ETF" /> ETF</label>
          <label class="chip"><input type="checkbox" value="ì±„ê¶Œ" /> ì±„ê¶Œ</label>
        </div>
      </div>
      <div class="field">
        <div class="label">íˆ¬ì ìŠ¤íƒ€ì¼(ë‹¨ì¼ ì„ íƒ)</div>
        <div class="chips radios" id="style-prefs">
          <label class="chip"><input type="radio" name="style" value="ì•ˆì •í˜•" /> ì•ˆì •í˜•</label>
          <label class="chip"><input type="radio" name="style" value="ê· í˜•í˜•" /> ê· í˜•í˜•</label>
          <label class="chip"><input type="radio" name="style" value="ê³µê²©í˜•" /> ê³µê²©í˜•</label>
        </div>
      </div>
      <div class="field">
        <div class="label">ê´€ì‹¬ ì¢…ëª©/ì¢…ë¥˜(ë³µìˆ˜ ì„ íƒ)</div>
        <div class="chips checks" id="sector-prefs">
          <label class="chip"><input type="checkbox" value="ì€í–‰" /> ì€í–‰</label>
          <label class="chip"><input type="checkbox" value="í†µì‹ " /> í†µì‹ </label>
          <label class="chip"><input type="checkbox" value="ë°˜ë„ì²´" /> ë°˜ë„ì²´</label>
          <label class="chip"><input type="checkbox" value="ìë™ì°¨" /> ìë™ì°¨</label>
          <label class="chip"><input type="checkbox" value="ì—ë„ˆì§€" /> ì—ë„ˆì§€</label>
          <label class="chip"><input type="checkbox" value="ë¦¬ì¸ /ë¶€ë™ì‚°" /> ë¦¬ì¸ /ë¶€ë™ì‚°</label>
        </div>
      </div>
      <div class="row">
        <button class="btn primary" id="btn-save-prefs">íˆ¬ì ì„±í–¥ ì €ì¥</button>
        <div id="prefs-status" class="status">ì €ì¥ë˜ì§€ ì•ŠìŒ</div>
      </div>
    </div>
  </div>
</section>

<!-- ê¸°ë³¸ ê°€ì¤‘ì¹˜ -->
<section class="panel">
  <h2>ğŸ“Š ê¸°ë³¸ ê°€ì¤‘ì¹˜ (ê· í˜•í˜•)</h2>
  <ul class="weights-list">
    <li>ROE: <strong>40%</strong></li>
    <li>ë°°ë‹¹: <strong>30%</strong></li>
    <li>PER: <strong>15%</strong></li>
    <li>PBR: <strong>15%</strong></li>
  </ul>
</section>

<!-- CSV ì—…ë¡œë“œ í…Œì´ë¸” -->
<section class="panel">
  <h2>ì¢…ëª©ë³„ ì£¼ì‹ ì¶”ì²œ</h2>
  <div class="row">
    <!-- CSV ì—…ë¡œë“œ ë¶€ë¶„ì€ ì œê±°í•˜ê±°ë‚˜ ì£¼ì„ ì²˜ë¦¬ -->
    <!-- <label for="csv-file" class="btn ghost">CSV ì—…ë¡œë“œ</label>
    <input id="csv-file" type="file" accept=".csv" class="hidden" /> -->
    <button id="btn-refresh" class="btn ghost">ì‹¤ì‹œê°„ ë­í‚¹ ìƒˆë¡œê³ ì¹¨</button>
    <button id="btn-download" class="btn small">í˜„ì¬ í‘œ CSVë¡œ ì €ì¥</button>
    <span id="rank-status" class="status">ë²„íŠ¼ì„ ëˆŒëŸ¬ ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¤ì„¸ìš”</span>
  </div>
  <div class="table-wrap">
    <table id="rank-table">
      <thead>
        <tr>
          <th>ì¢…ëª©ëª…</th><th>ì ìˆ˜</th><th>ë°°ë‹¹%</th><th>ROE%</th><th>PER</th><th>PBR</th><th>ì„¹í„°</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
  // ğŸ”¹ Django URL reverseë¥¼ JS ìƒìˆ˜ë¡œ ë¹¼ë‘ê¸°
  const RANKING_API_URL = "{% url 'finances:dividend_ranking_api' %}";
</script>

<script>
  async function loadRanking() {
    const status = document.getElementById('rank-status');
    const tbody = document.querySelector('#rank-table tbody');
    tbody.innerHTML = '';
    status.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
    status.classList.remove('ok');

    try {
      // ğŸ”¹ í•˜ë“œì½”ë”© URL ëŒ€ì‹  Djangoì—ì„œ ë§Œë“  URL ì‚¬ìš©
      const res = await fetch(RANKING_API_URL);
      if (!res.ok) throw new Error("API ì˜¤ë¥˜");

      const data = await res.json();
      const rows = data.rows || [];

      rows.forEach(row => {
        const tr = document.createElement('tr');

        const to2 = (val) => {
          const num = parseFloat(val);
          return isNaN(num) ? '-' : num.toFixed(2);
        };

        const cells = [
          row.name,
          to2(row.score),
          to2(row.DIV),
          to2(row.ROE_est),
          to2(row.PER),
          to2(row.PBR),
          row.Sector,
        ];

        cells.forEach(cell => {
          const td = document.createElement('td');
          td.textContent = cell;
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });

      status.textContent = `ì—…ë°ì´íŠ¸ ì™„ë£Œ (ê¸°ì¤€ì¼: ${data.base_date})`;
      status.classList.add('ok');
    } catch (err) {
      console.error(err);
      status.textContent = 'ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨';
    }
  }

  // ë²„íŠ¼ í´ë¦­ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
  document.getElementById('btn-refresh').addEventListener('click', loadRanking);

  // í˜ì´ì§€ ì§„ì… ì‹œ ìë™ ì‹¤í–‰í•˜ê³  ì‹¶ìœ¼ë©´:
  // window.addEventListener('DOMContentLoaded', loadRanking);
</script>
{% endblock %}