<script setup>
import { ref, onMounted, reactive } from 'vue'
import axios from 'axios'
import { useUserStore } from '@/stores/user'
import { useFinanceStore } from '@/stores/finance'
import PageHeader from '@/components/layout/PageHeader.vue'
import BaseCard from '@/components/BaseCard.vue'

const userStore = useUserStore()
const financeStore = useFinanceStore()

const loading = ref(true)
const stocks = ref([])
const baseDate = ref('')

// 사용자 입력 데이터
const userProfile = reactive({
  investment_style: 'balanced', 
  preferred_products: [] 
})

const products = [
  { label: '배당주', value: 'dividend' },
  { label: '성장주', value: 'growth' },
  { label: '가치주', value: 'value' },
  { label: '리츠', value: 'reits' },
  { label: 'ETF', value: 'etf' },
]

const styles = [
  { label: '안정형', value: 'stable', icon: '🛡️' },
  { label: '균형형', value: 'balanced', icon: '⚖️' },
  { label: '공격형', value: 'aggressive', icon: '🔥' },
]

// 1. 데이터 가져오기 (로그인 상관없이 요청)
const fetchData = async () => {
  loading.value = true
  try {
    // 토큰이 없어도 요청을 보냄 (백엔드가 AllowAny라면 응답 옴)
    const res = await axios.get(`${financeStore.API_URL}/api/finances/stocks/recommend/`, {
      headers: { Authorization: `Bearer ${userStore.token}` }
    })
    
    // 백엔드 응답 구조 ({ rows: [...], base_date: "..." }) 처리
    if (res.data.rows) {
      stocks.value = res.data.rows
      baseDate.value = res.data.base_date
    } else {
      stocks.value = res.data
    }

  } catch (err) {
    console.error("데이터 로딩 실패:", err)
  } finally {
    loading.value = false
  }
}

// 2. 성향 저장 (로그인 시에만 성공하겠지만, 일단 요청은 허용)
const savePreference = async () => {
  // 로그인 체크 제거 (요청은 보냄)
  try {
    await axios.put(`${financeStore.API_URL}/api/accounts/profile/preference/`, {
      investment_style: userProfile.investment_style,
      preferred_products: userProfile.preferred_products
    }, {
      headers: { Authorization: `Bearer ${userStore.token}` }
    })
    
    alert('투자 성향이 반영되었습니다! 📝')
    fetchData() 

  } catch (err) {
    console.error(err)
    // 로그인이 안 되어 있으면 401 에러가 날 수 있음
    if (!userStore.isLogin) {
      alert('성향을 저장하려면 로그인이 필요합니다. (추천 결과는 임시로 보여집니다)')
      fetchData() // 저장은 실패해도 리스트는 다시 불러오기 시도
    } else {
      alert('저장에 실패했습니다.')
    }
  }
}

onMounted(() => {
  fetchData()
})
</script>

<template>
  <div class="max-w-7xl mx-auto px-4 py-10 min-h-screen">
    
    <PageHeader 
      title="📈 맞춤 주식 추천" 
      subtitle="투자 성향을 분석하여 최적의 종목을 추천해 드립니다." 
    />

    <div class="max-w-3xl mx-auto mb-12">
      <BaseCard class="bg-white border border-gray-100 shadow-xl rounded-3xl p-8">
        <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
          🎯 투자 성향 설정
        </h3>
        
        <!-- <div class="mb-8">
          <label class="block text-sm font-bold text-gray-500 mb-3">선호 상품 (복수 선택 가능)</label>
          <div class="flex flex-wrap gap-3">
            <label v-for="item in products" :key="item.value" 
                   class="cursor-pointer border rounded-full px-5 py-2.5 transition-all select-none text-sm font-medium"
                   :class="userProfile.preferred_products.includes(item.value) 
                     ? 'bg-blue-600 text-white border-blue-600 shadow-md ring-2 ring-blue-200' 
                     : 'bg-gray-50 text-gray-600 border-gray-200 hover:bg-gray-100'"
            >
              <input type="checkbox" :value="item.value" v-model="userProfile.preferred_products" class="hidden">
              {{ item.label }}
            </label>
          </div>
        </div> -->

        <div class="mb-10">
          <label class="block text-sm font-bold text-gray-500 mb-3">투자 스타일</label>
          <div class="grid grid-cols-3 gap-4">
            <label v-for="style in styles" :key="style.value" 
                   class="cursor-pointer border rounded-2xl px-4 py-4 flex flex-col items-center gap-2 transition-all select-none hover:shadow-sm"
                   :class="userProfile.investment_style === style.value 
                     ? 'bg-blue-50 border-blue-500 text-blue-700 ring-1 ring-blue-500 font-bold shadow-md' 
                     : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50'"
            >
              <input type="radio" :value="style.value" v-model="userProfile.investment_style" class="hidden">
              <span class="text-3xl">{{ style.icon }}</span>
              <span class="text-base">{{ style.label }}</span>
            </label>
          </div>
        </div>

        <button @click="savePreference" class="btn bg-blue-600 text-white hover:bg-blue-700 w-full border-none shadow-lg text-lg h-14 rounded-2xl">
          성향 저장 및 추천 받기
        </button>
      </BaseCard>
    </div>

    <BaseCard class="bg-white border border-gray-100 shadow-xl rounded-3xl overflow-hidden">
      <div class="p-6 border-b border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4">
        <div class="flex items-center gap-3">
          <h3 class="text-xl font-bold text-gray-800">
            📊 고배당/가치주 추천 랭킹
          </h3>
          <span v-if="baseDate" class="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded">
            {{ baseDate }} 기준
          </span>
        </div>
        <button @click="fetchData" class="btn btn-sm btn-ghost gap-2 border border-gray-200 bg-white hover:bg-gray-50">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" /></svg>
          추천 종목 새로고침
        </button>
      </div>

      <div class="overflow-x-auto">
        <table class="table w-full">
          <thead>
            <tr class="bg-gray-50 text-gray-500 text-sm uppercase">
              <th class="py-4 pl-8 text-left">순위</th>
              <th class="py-4 text-left">종목명</th>
              <th class="py-4 text-center">종합점수</th>
              <th class="py-4 text-right">배당률(%)</th>
              <th class="py-4 text-right">ROE(%)</th>
              <th class="py-4 text-right">PER</th>
              <th class="py-4 text-right">PBR</th>
              <th class="py-4 pr-8 text-center">섹터</th>
            </tr>
          </thead>
          
          <tbody>
            <tr v-if="loading">
              <td colspan="8" class="text-center py-20">
                <span class="loading loading-spinner loading-lg text-primary"></span>
              </td>
            </tr>
            <tr v-else-if="stocks.length === 0">
              <td colspan="8" class="text-center py-20 text-gray-400">
                추천할 종목이 없습니다.
              </td>
            </tr>
            <tr v-else v-for="(stock, index) in stocks" :key="stock.ticker" class="hover:bg-blue-50/50 transition-colors border-b border-gray-50 group cursor-pointer">
              <td class="py-4 pl-8 font-bold text-lg text-blue-600">{{ index + 1 }}</td>
              <td class="py-4 font-bold text-gray-800 flex items-center gap-2">
                {{ stock.name }}
                <span class="text-xs font-normal text-gray-400">{{ stock.ticker }}</span>
              </td>
              <td class="py-4 text-center">
                <div class="badge badge-primary badge-outline font-bold">{{ stock.score }}점</div>
              </td>
              <td class="py-4 text-right font-medium text-red-500">{{ stock.DIV }}%</td>
              <td class="py-4 text-right">{{ stock.ROE_est ? stock.ROE_est.toFixed(2) : '-' }}</td>
              <td class="py-4 text-right">{{ stock.PER }}</td>
              <td class="py-4 text-right">{{ stock.PBR }}</td>
              <td class="py-4 pr-8 text-center">
                <span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs">{{ stock.Sector }}</span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div class="p-6 bg-gray-50 text-center text-xs text-gray-400 border-t border-gray-100">
        추천서비스 결과는 투자 참고용일 뿐입니다. (제공: FinanceDataReader)
      </div>
    </BaseCard>

  </div>
</template>