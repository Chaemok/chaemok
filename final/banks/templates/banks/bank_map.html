{% extends "base.html" %}
{% load static %}

{% block title %}ì€í–‰/ì¦ê¶Œì‚¬ ì°¾ê¸° - ê³ ì•¤ëª© ê¸ˆìœµ ì»¤ë®¤ë‹ˆí‹°{% endblock %}
{% block nav_banks %}active{% endblock %}

{% block content %}
<section class="panel-section">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
    <h2 class="section-title" style="margin:0;">ì€í–‰ / ì¦ê¶Œì‚¬ / ATM ì°¾ê¸°</h2>
    <button id="btn-my-loc" class="btn small outline" style="border-radius:20px;">
      ğŸ“ ë‚´ ìœ„ì¹˜ë¡œ ì´ë™
    </button>
  </div>
  
  <p class="section-subtitle">
    ì›í•˜ëŠ” ì§€ì—­ê³¼ ê¸ˆìœµê¸°ê´€ì„ ì„ íƒí•˜ì—¬ ê²€ìƒ‰í•˜ì„¸ìš”. (ì „ì²´ë¡œ ì„¤ì •í•˜ë©´ ë‚´ ìœ„ì¹˜ ì£¼ë³€ ê²€ìƒ‰ê°€ëŠ¥í•©ë‹ˆë‹¤.)
  </p>

  <div class="filter-box" style="background:#f8f9fa; padding:20px; border-radius:12px; margin-bottom:20px; border:1px solid #e9ecef;">
    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items: flex-end;">
      
      <div style="flex:1; min-width: 120px;">
        <label style="font-size:12px; color:#666; font-weight:bold; display:block; margin-bottom:5px;">ê´‘ì—­ì‹œ / ë„</label>
        <select id="sido-select" class="select" style="width:100%; padding:10px;">
          <option value="">ì „ì²´</option>
        </select>
      </div>
      
      <div style="flex:1; min-width: 120px;">
        <label style="font-size:12px; color:#666; font-weight:bold; display:block; margin-bottom:5px;">ì‹œ / êµ° / êµ¬</label>
        <select id="gugun-select" class="select" style="width:100%; padding:10px;" disabled>
          <option value="">ì „ì²´</option>
        </select>
      </div>

      <div style="flex:0.8; min-width: 110px;">
        <label style="font-size:12px; color:#666; font-weight:bold; display:block; margin-bottom:5px;">êµ¬ë¶„</label>
        <select id="type-select" class="select" style="width:100%; padding:10px;">
          <option value="BANK">ì€í–‰</option>
          <option value="SEC">ì¦ê¶Œì‚¬</option>
          <option value="ATM">ATM (365ì½”ë„ˆ)</option> </select>
      </div>

      <div style="flex:1.2; min-width: 140px;">
        <label style="font-size:12px; color:#666; font-weight:bold; display:block; margin-bottom:5px;">ê¸ˆìœµê¸°ê´€ ì„ íƒ</label>
        <select id="bank-select" class="select" style="width:100%; padding:10px;">
          <option value="ALL_BANK">ì „ì²´ ì€í–‰</option>
        </select>
      </div>

      <button id="btn-search-filter" class="btn primary" style="padding:10px 24px; height: 42px;">
        ğŸ” ê²€ìƒ‰
      </button>
    </div>
  </div>

  <div class="split-container" style="display: flex; gap: 20px; height: 600px;">
    <div id="map-wrapper" style="flex: 7; height: 100%; position: relative;">
      <div id="map" style="width: 100%; height: 100%; border-radius: 8px; border: 1px solid #ddd;"></div>
      
      <button id="btn-re-search" class="btn primary" style="
        position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 10; display: none; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.2); border-radius: 20px; padding: 8px 20px; font-weight: bold;">
        ğŸ”„ í˜„ ì§€ë„ì—ì„œ ì¬ê²€ìƒ‰
      </button>
    </div>

    <div class="result-wrapper" style="flex: 3; height: 100%; display: flex; flex-direction: column; border: 1px solid #eee; border-radius: 8px; background: #fff;">
      <div class="result-header" style="padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fdfdfd; border-radius: 8px 8px 0 0;">
        <h3 class="result-title" style="margin:0; font-size: 16px;">ê²€ìƒ‰ ê²°ê³¼</h3>
        <span id="result-count" class="result-count" style="color:#007bff; font-weight:bold;">0ê±´</span>
      </div>
      <ul id="result-list" class="result-list" style="list-style:none; padding:0; margin:0; overflow-y:auto; flex: 1;">
        <li style="padding:40px 0; text-align:center; color:#888;">
          <div style="font-size:30px; margin-bottom:10px;">ğŸ—ºï¸</div>
          ì§€ë„ë¥¼ ì›€ì§ì´ê±°ë‚˜<br>ê²€ìƒ‰ ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”.
        </li>
      </ul>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_map_js_key }}&libraries=services"></script>

<script>
// ===========================
// [ì„¤ì •] ì´ë¯¸ì§€ ë° ë§ˆì»¤
// ===========================
const IMG_MY   = "{% static 'images/marker_red.png' %}";
const IMG_BANK = "{% static 'images/marker_blue.png' %}";
const IMG_SEC  = "{% static 'images/marker_green.png' %}";
const IMG_ATM  = "{% static 'images/marker_atm.png' %}"; 

const MARKER_SIZE = new kakao.maps.Size(35, 35); 

let map, places, geocoder, infowindow;
let markers = [];
let myLocationMarker = null;
let myLocationOverlay = null;
let koreaAreas = {};
let financialInstitutions = [];
let allPlaces = []; 

document.addEventListener("DOMContentLoaded", async function () {
  
  try {
    const response = await fetch("{% static 'data/financial_data.json' %}");
    if (!response.ok) throw new Error("JSON ë¡œë“œ ì‹¤íŒ¨");
    const data = await response.json();
    koreaAreas = data.koreaAreas;
    financialInstitutions = data.financialInstitutions;
    initUI(); 
  } catch (error) {
    console.error("ë°ì´í„° ë¡œë”© ì—ëŸ¬:", error);
  }

  if (!window.kakao || !kakao.maps) { alert("ì¹´ì¹´ì˜¤ ì§€ë„ ë¡œë“œ ì‹¤íŒ¨"); return; }
  
  const container = document.getElementById("map");
  const options = { center: new kakao.maps.LatLng(37.5665, 126.9780), level: 4 };
  map = new kakao.maps.Map(container, options);

  places = new kakao.maps.services.Places();
  geocoder = new kakao.maps.services.Geocoder();
  infowindow = new kakao.maps.InfoWindow({ zIndex: 1 });

  kakao.maps.event.addListener(map, 'dragend', showReSearchBtn);
  kakao.maps.event.addListener(map, 'zoom_changed', showReSearchBtn);

  moveToMyLocation();

  // ===========================
  // UI ì´ˆê¸°í™”
  // ===========================
  function initUI() {
    const sidoSel = document.getElementById("sido-select");
    const gugunSel = document.getElementById("gugun-select");
    const typeSel = document.getElementById("type-select");
    const bankSel = document.getElementById("bank-select");
    const searchBtn = document.getElementById("btn-search-filter");
    const reSearchBtn = document.getElementById("btn-re-search");
    const myLocBtn = document.getElementById("btn-my-loc");

    for (const key in koreaAreas) {
      const opt = document.createElement("option");
      opt.value = key;
      opt.textContent = key;
      sidoSel.appendChild(opt);
    }

    sidoSel.addEventListener("change", function() {
      const selected = this.value;
      gugunSel.innerHTML = '<option value="">ì „ì²´</option>';
      gugunSel.disabled = !selected;
      if (selected && koreaAreas[selected]) {
        koreaAreas[selected].forEach(gu => {
          const opt = document.createElement("option");
          opt.value = gu;
          opt.textContent = gu;
          gugunSel.appendChild(opt);
        });
      }
    });

    typeSel.addEventListener("change", function() {
      updateBankList(this.value);
    });
    updateBankList("BANK"); 

    function updateBankList(type) {
      bankSel.innerHTML = "";
      const allOpt = document.createElement("option");
      
      if (type === "BANK") {
        allOpt.value = "ALL_BANK";
        allOpt.textContent = "ì „ì²´ ì€í–‰";
      } else if (type === "SEC") {
        allOpt.value = "ALL_SEC";
        allOpt.textContent = "ì „ì²´ ì¦ê¶Œì‚¬";
      } else if (type === "ATM") {
        allOpt.value = "ALL_ATM";
        allOpt.textContent = "ì „ì²´ ATM";
      }
      bankSel.appendChild(allOpt);

      if (type !== "ATM") {
        financialInstitutions.forEach(inst => {
          if (inst.type === type) {
            const opt = document.createElement("option");
            opt.value = inst.name;
            opt.textContent = inst.name;
            opt.dataset.type = inst.type;
            bankSel.appendChild(opt);
          }
        });
      }
    }

    searchBtn.addEventListener("click", executeSearch);
    myLocBtn.addEventListener("click", moveToMyLocation);
    
    reSearchBtn.addEventListener("click", function() {
      const bankSelectEl = document.getElementById("bank-select");
      const targetValue = bankSelectEl.value;
      const typeSelectVal = document.getElementById("type-select").value;
      
      if (map.getLevel() > 8) alert("ì§€ë„ê°€ ë„ˆë¬´ ë„“ìŠµë‹ˆë‹¤. ì¡°ê¸ˆë§Œ í™•ëŒ€(ì¤Œì¸)í•´ì„œ ê²€ìƒ‰í•´ì£¼ì„¸ìš”.");
      searchPlaces(targetValue, typeSelectVal, null, 0); 
      this.style.display = 'none';
    });
  }

  function showReSearchBtn() {
    const btn = document.getElementById("btn-re-search");
    if (btn) btn.style.display = 'block';
  }

  function moveToMyLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition((pos) => {
          const loc = new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
          map.setCenter(loc);
          map.setLevel(4);
          
          const markerImage = new kakao.maps.MarkerImage(IMG_MY, MARKER_SIZE);
          if (myLocationMarker) myLocationMarker.setMap(null);
          myLocationMarker = new kakao.maps.Marker({ map: map, position: loc, image: markerImage, zIndex: 3 });

          const iwContent = '<div style="padding:5px; font-size:12px; background:white; border:1px solid #ccc; border-radius:3px; white-space:nowrap;">ğŸ“ í˜„ìœ„ì¹˜</div>';
          if (myLocationOverlay) myLocationOverlay.setMap(null);
          myLocationOverlay = new kakao.maps.CustomOverlay({ position: loc, content: iwContent, yAnchor: 2.2 });
          myLocationOverlay.setMap(map);
          document.getElementById("btn-re-search").style.display = 'none';
      }, (err) => alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
    }
  }

  // ===========================
  // [ìˆ˜ì •ëœ ë¶€ë¶„] ê²€ìƒ‰ ì‹¤í–‰ (ë°˜ê²½ í™•ëŒ€)
  // ===========================
  function executeSearch() {
    const sido = document.getElementById("sido-select").value;
    const gugun = document.getElementById("gugun-select").value;
    const bankSelectEl = document.getElementById("bank-select");
    const targetValue = bankSelectEl.value;
    const typeSelectVal = document.getElementById("type-select").value;
    
    document.getElementById("btn-re-search").style.display = 'none';

    if (sido) {
      let address = sido;
      if (gugun) address += " " + gugun;

      geocoder.addressSearch(address, function(result, status) {
        if (status === kakao.maps.services.Status.OK) {
          const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
          map.setCenter(coords);
          
          let searchRadius = 10000; // ê¸°ë³¸ê°’ì„ 10kmë¡œ ëŠ˜ë¦¼

          if (gugun) { 
            // ì‹œ/êµ°/êµ¬ ì„ íƒ ì‹œ
            map.setLevel(7);      // â˜… ì¤Œ ë ˆë²¨ 6 -> 7ë¡œ ë³€ê²½ (ë” ë„“ê²Œ ë³´ê¸°)
            searchRadius = 10000; // â˜… ë°˜ê²½ 5km -> 10kmë¡œ í™•ì¥
          } 
          else { 
            // ê´‘ì—­ì‹œ/ë„ ì„ íƒ ì‹œ
            map.setLevel(9);      // â˜… ì¤Œ ë ˆë²¨ 8 -> 9ë¡œ ë³€ê²½
            searchRadius = 20000; // ìµœëŒ€ 20km ìœ ì§€
          }
          
          setTimeout(() => searchPlaces(targetValue, typeSelectVal, coords, searchRadius), 100);
        } else {
          alert("ì§€ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
      });
    } else {
      searchPlaces(targetValue, typeSelectVal, null, 0);
    }
  }

  // ===========================
  // ì¥ì†Œ ê²€ìƒ‰ ë° í•„í„°ë§
  // ===========================
  function searchPlaces(keyword, type, centerCoords, radiusVal) {
    clearMarkers();
    allPlaces = [];
    
    let options = {};
    if (radiusVal > 0 && centerCoords) {
      options = { location: centerCoords, radius: radiusVal, sort: kakao.maps.services.SortBy.DISTANCE };
    } else {
      options = { useMapBounds: true };
    }
    
    const callback = function(data, status, pagination) {
      if (status === kakao.maps.services.Status.OK) {
        let filteredData = data.filter(place => {
          const name = place.place_name || "";
          const isATM = name.includes("ATM") || name.includes("365") || name.includes("ì ì™¸") || name.includes("CD");

          if (type === "BANK") return !isATM; 
          else if (type === "ATM") return isATM;
          return true; 
        });

        allPlaces.push(...filteredData);

        if (pagination.hasNextPage) {
          pagination.nextPage();
        } else {
          displayPlaces(allPlaces, type);
        }
      } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
        if (allPlaces.length === 0) displayNoResult();
      }
    };

    if (type === "ATM") places.keywordSearch('ATM', callback, options);
    else if (keyword === "ALL_BANK") places.categorySearch('BK9', callback, options);
    else if (keyword === "ALL_SEC") places.keywordSearch('ì¦ê¶Œì‚¬', callback, options);
    else places.keywordSearch(keyword, callback, options);
  }

  function displayNoResult() {
    document.getElementById("result-count").textContent = "0ê±´";
    document.getElementById("result-list").innerHTML = `
      <li style="padding:40px 0; text-align:center; color:#888;">
        <div style="font-size:30px; margin-bottom:10px;">ğŸ“­</div>
        ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.<br><small>ì§€ë„ë¥¼ ì´ë™í•˜ê±°ë‚˜ ì¡°ê±´ì„ ë³€ê²½í•´ë³´ì„¸ìš”.</small>
      </li>
    `;
  }

  function displayPlaces(data, type) {
    const listEl = document.getElementById("result-list");
    const countEl = document.getElementById("result-count");
    listEl.innerHTML = "";
    countEl.textContent = `${data.length}ê±´`;

    let markerImgSrc = IMG_BANK;
    if (type === "SEC") markerImgSrc = IMG_SEC;
    else if (type === "ATM") markerImgSrc = IMG_ATM;

    const markerImage = new kakao.maps.MarkerImage(markerImgSrc, MARKER_SIZE);
    const bounds = new kakao.maps.LatLngBounds();

    data.forEach((place, idx) => {
      const pos = new kakao.maps.LatLng(place.y, place.x);
      const marker = new kakao.maps.Marker({ map: map, position: pos, image: markerImage, title: place.place_name });
      markers.push(marker);
      bounds.extend(pos);

      const li = document.createElement("li");
      li.style.padding = "15px";
      li.style.borderBottom = "1px solid #eee";
      li.style.cursor = "pointer";
      li.onmouseover = function() { this.style.backgroundColor = "#f8f9fa"; };
      li.onmouseout = function() { this.style.backgroundColor = "white"; };
      
      li.innerHTML = `
        <div style="font-weight:bold; font-size:14px; margin-bottom:4px;">${idx+1}. ${place.place_name}</div>
        <div style="font-size:12px; color:#666;">${place.road_address_name || place.address_name}</div>
        <div style="font-size:12px; color:#007bff; margin-top:2px;">${place.phone || ''}</div>
      `;
      li.addEventListener("click", () => {
        map.panTo(pos);
        const content = `<div style="padding:5px;font-size:12px;"><strong>${place.place_name}</strong></div>`;
        infowindow.setContent(content);
        infowindow.open(map, marker);
      });
      listEl.appendChild(li);
    });

    if (data.length > 0) map.setBounds(bounds);
  }

  function clearMarkers() {
    markers.forEach(m => m.setMap(null));
    markers = [];
  }
});
</script>
{% endblock %}